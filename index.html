<!DOCTYPE html>
<html>
    <meta charset="utf-8">
    <head><title>強震モニタ　音声通知</title></head>
    <script>

// http://www.kmoni.bosai.go.jp/webservice/hypo/eew/20210214194741.json?jsoncallback=callback
// 20210215141000

const url = 'http://www.kmoni.bosai.go.jp/webservice/hypo/eew/';

let timeoutId = 0;
let scriptTag;
let prevText = '';
let testVoice = 'これはテストです。';
let startTime = 0;

window.callback = (payload) => {
    if(timeoutId) {
        clearTimeout(timeoutId);
        timeoutId = 0;
    }
    if(scriptTag) {
        document.body.removeChild(scriptTag);
        scriptTag = null;
    }

    if(testVoice) {
        payload.magunitude = 7.2;
        payload.region_name = '和歌山県北部';
        payload.calcintensity = 5;
    }

    if(payload.magunitude && payload.region_name && payload.calcintensity) {
        const text = `地震発生！震度${payload.calcintensity}、${payload.region_name}、マグニチュード${payload.magunitude}`;
        if(prevText !== text) {
            prevText = text;
            const utterance = new SpeechSynthesisUtterance();
            utterance.lang = 'ja-JP';
            utterance.text = testVoice + text;
            speechSynthesis.speak(utterance);
            if(!testVoice) {
                console.log(new Date(), text);
            }
            testVoice = '';
        }
    }
    setTimeout(loadJsonP, 1000);
};

const removeScript = () => {
    console.log('connection failed');
    timeoutId = 0;
    document.body.removeChild(scriptTag);
    scriptTag = null;

    loadJsonP();
}

const n = (str) => {
    return ('0' + str).substr(-2);
}

const loadJsonP = () => {
    const script = document.createElement('script');
    let d = new Date(Date.now() - 5000);
    if(false) {
        d = new Date((Date.now() - startTime) + 1613365800000 + 30000);
    }
    script.src = url + `${d.getFullYear()}${n(d.getMonth() + 1)}${n(d.getDate())}${n(d.getHours())}${n(d.getMinutes())}${n(d.getSeconds())}.json?jsoncallback=callback`;
    scriptTag = document.body.appendChild(script);
    timeoutId = setTimeout(removeScript, 10000);
};
onload = () => {
    //loadJsonP();
    //console.log('load',document.body.getElementsByTagName('input'))
    document.body.getElementsByTagName('input')[0].onclick = () => {
        console.log("script started");
        document.body.getElementsByTagName('input')[0].onclick = () => {};
        startTime = Date.now();
        loadJsonP();
    }
};
    </script>
    <body>
        <input type="button" value="start"> 最初にテストが流れます
    </body>
</html>